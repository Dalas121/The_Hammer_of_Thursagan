#textdomain wesnoth-thot

[scenario]
    id=08_The_Court_of_Karrag
    name= _ "The Court of Karrag"
    map_file=08_The_Court_of_Karrag.map
    turns=15
    next_scenario=09_The_Underlevels
    victory_when_enemies_defeated=yes

    {UNDERGROUND}

    {SCENARIO_MUSIC       the_king_is_dead.ogg}
    {EXTRA_SCENARIO_MUSIC revelation.ogg}
    {EXTRA_SCENARIO_MUSIC transience.ogg}

    {THOT_TRACK {JOURNEY_STAGE8}}

    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {PLAYER_SIDE SHROUD=yes}

    #############################
    # KAL KARTHANS
    #############################
    [side]
        side=2
        color=black
        controller=ai
        # No gold or recruits this scenario
        team_name=evil
        user_team_name= _ "Kal Karthans"
        {FLAG_VARIANT knalgan}

        {CHARACTER_STATS_KARRAG_PREREV}
        facing=sw
        [ai]
            {NO_SCOUTS}
            passive_leader=yes
            grouping=defensive
        [/ai]
    [/side]
    {STARTING_VILLAGES_ALL 2}

    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        [item]
            x,y=11,6
            image=units/dwarves/lord-se-hammer-defend1.png~GS()~CS(15,15,15)~SCALE_SHARP(100,100)
        [/item]
        [item]
            x,y=11,9
            image=units/dwarves/sentinel.png~GS()~CS(15,15,15)~SCALE_SHARP(100,100)
        [/item]
        [item]
            x,y=26,10
            image=units/dwarves/lord.png~GS()~CS(15,15,15)~SCALE_SHARP(100,100)~FL()
        [/item]
        [item]
            x,y=25,5
            image=units/dwarves/explorer-ranged-1.png~GS()~CS(15,15,15)~SCALE_SHARP(100,100)~FL(0
        [/item]
        [item]
            x,y=7,2
            image=units/dwarves/lord-ne-hammer-defend1.png~GS()~CS(15,15,15)~SCALE_SHARP(100,100)
        [/item]
        [item]
            x,y=13,18
            image=units/dwarves/explorer-ranged-1.png~GS()~CS(15,15,15)~SCALE_SHARP(100,100)~FL()
        [/item]
        
        {PLACE_IMAGE "scenery/rune1-glow.png" 22  5}
        {PLACE_IMAGE "scenery/rune2-glow.png" 22  9}
        {PLACE_IMAGE "scenery/rune3-glow.png" 19  6}
        {PLACE_IMAGE "scenery/rune4-glow.png" 18  7}
        {PLACE_IMAGE "scenery/rune5-glow.png" 19  9}
        
        {PLACE_IMAGE "scenery/rune1-glow.png" 14  5}
        {PLACE_IMAGE "scenery/rune2-glow.png" 14  9}

        {PLACE_IMAGE "scenery/dwarven-doors-closed.png" 22 7}
        
        [unstore_unit]
            variable=stored_Dulcatulos
            x,y=5,19
        [/unstore_unit]
        {MODIFY_UNIT id=Dulcatulos facing ne}
        
        {RECALL_XY Angarthing 4 19}
        {MODIFY_UNIT side=1 facing se}
        {SCROLL_TO 4 19}
        
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
    [/event]

    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start

        #############################
        # FIRST STEPS
        #############################
        {DELAY 500}
        {MOVE_UNIT id=Dulcatulos 8 16}
        {MOVE_UNIT id=Aiglondur  8 17} {REDRAW}
        {MOVE_UNIT id=Angarthing 7 18} {REDRAW}
        {DELAY 500}
        {MOVE_UNIT id=Dulcatulos 9 15}
        {MOVE_UNIT id=Aiglondur  8 15} {REDRAW}
        {MOVE_UNIT id=Angarthing 8 16} {REDRAW}
        [message]
            speaker=Dulcatulos
            message= _ "This way, Knalgans. Long has it been since any of your kind found your way to our humble hold. Our throne room lies just ahead; the runemaster Karrag will surely be eager to see you."
        [/message]
        [message]
            speaker=Angarthing
            message= _ "A runemaster? There have been none such since Thursagan’s day. And for one to lead a holding was unheard-of; they tended towards the solitary life."
        [/message]
        [message]
            speaker=Dulcatulos
            message= _ "Aye? Well, you’d know such things better than I, loremaster. Our Karrag toiled for long years to recover the craft lore. He was elevated when our old lord fell in battle against invading orcs; the same orcs what once besieged Knalga."
        [/message]
        [message]
            speaker=Dulcatulos
            message= _ "Karrag himself was wounded near to death; none thought he would recover. But he leads us today, and his runelore has oft been the only shield between us and the invaders."
        [/message]
        {DELAY 500}
        [message]
            speaker=Aiglondur
            message={WHISPER _"Angarthing... this is a strange thing. Our guide speaks brightly, with no lingering malice from our battle."}
        [/message]
        [message]
            speaker=Angarthing
            message={WHISPER _"Aye. This is not the same mind whom I banished back in the fields."}
        [/message]
        {DELAY 500}
        [message]
            speaker=Dulcatulos
            message= _ "Karrag has grasped the Hammer of Thursagan. Toils over it in a workshop in the underlevels with his personal followers. He has promised all of us that the Hammer’s power will smash and scatter all our enemies!"
        [/message]
        [message]
            speaker=Angarthing
            message= _ "That is strange. The Hammer is a tool of crafting and making, not a weapon. What can he mean to do with it?"
        [/message]
        [message]
            speaker=Dulcatulos
            message= _ "That’s for lords and loremasters to worry about, not the likes of me. Karrag has his faults, but he kept us safe from the orcs. Else we’d have suffered as badly as Knalga, or worse."
        [/message]

        #############################
        # FINAL STEPS
        #############################
        {DELAY 500}
        {MOVE_UNIT id=Dulcatulos 11 13}
        {MOVE_UNIT id=Aiglondur  11 14} {REDRAW}
        {MOVE_UNIT id=Angarthing 10 14} {REDRAW}
        {DELAY 500}
        {MOVE_UNIT id=Dulcatulos 13 11}
        {MOVE_UNIT id=Aiglondur  12 11} {REDRAW}
        {MOVE_UNIT id=Angarthing 11 12} {REDRAW}
        {DELAY 500}
        {MOVE_UNIT id=Dulcatulos 14 10}
        {MOVE_UNIT id=Aiglondur  15 11} {REDRAW}
        {MOVE_UNIT id=Angarthing 13 10} {REDRAW}
        [message]
            speaker=Dulcatulos
            message= _ "We are here."
        [/message]
        [modify_side]
            side=1
            shroud=no
        [/modify_side]
        {SCROLL_TO 20 7}
        
        #############################
        # MEETING KARRAG
        #############################
#define KARRAG_BLUE MESSAGE
"<span color='#87cefa'>" + {MESSAGE} + "</span>"
#enddef
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Where is your face, Dulcatulos? Do you defy my visage?"}
        [/message]
        [message]
            speaker=Dulcatulos
            message= _ "My lord, we have guests. Dwarves from Knalga."
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Knalga?"}
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Hail, Knalgans! Your clans are kin to ours of old; it is good to once more host Knalgans in these halls. All Kal Kartha rejoices at your presence."}
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"If you stand here before me, it can only be that you have freed your home and slaughtered the orcs that once assailed you. As it should be."}
        [/message]
        [message]
            speaker=Aiglondur
            message=_"Aye, so we have. But another slaughter has taken place outside these halls. This one, Dulcatulos, led your kin to terrorize your smallfolk. He wore a <b><i>mask</i></b>! ...as do you."
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"The face a dwarf wears matters not. All dwarves are kin, and must prevail against orcs and humans and other dirtgrubbers. You can be part of the fist that smites them."}
        [/message]
        [message]
            speaker=Angarthing
            message= _ "We did not come to smite anyone, but to re-open contact and trade."
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Trade? Your destruction of your besieging orcs was a far nobler act than trade. There can be more such victories. And there will be by the power of our ancient heirloom, the Hammer of Thursagan."}
        [/message]
        [message]
            speaker=Angarthing
            message= _ "It is remembered in Knalga that Kal Kartha holds the Hammer."
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Yes! And the Hammer holds the soul of the dwarves, the true people. Together, we can march to greater victories! Will you of Knalga join me?"}
        [/message]
        
        #############################
        # ANGARTHING'S ULTIMATUM
        #############################
        [message]
            speaker=Angarthing
            message= _ "On one condition. You must take off that mask and show your true face. I am a witness."
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"You... do not wish to see what is beneath this mask. I was terribly wounded in an orcish attack. Disfigured."}
        [/message]
        [message]
            speaker=Angarthing
            message= _ "But the Law must see. A dwarf must put his name and his face behind his deeds. I am a witness."
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"Impertinent fool! It is not for you to dictate to a lord in his own holding, much less one who holds the very soul of the dwarves in his hand."}
        [/message]
        [message]
            speaker=Angarthing
            message= _ "The Law speaks. Against him with the eyes to see, no deception can hold. I AM A WITNESS!"
        [/message]
        
        #############################
        # TAKING OFF THE MASK
        #############################
        {DELAY 250}
        [animate_unit]
            flag=levelout
            [filter]
                id=Karrag
            [/filter]
        [/animate_unit]
        {SOUND lich-hit-1.ogg}
        {TRANSFORM_UNIT id=Karrag "Undead Dwarvish Rune Lord"}
        {MODIFY_UNIT id=Karrag variation karrag-unmasked}
        {REDRAW}
        [animate_unit]
            flag=levelin
            [filter]
                id=Karrag
            [/filter]
        [/animate_unit]
        {DELAY 250}
        
        #############################
        # THE LICH IS REVEALED
        #############################
        [message]
            speaker=Dulcatulos
            scroll=no
            message= _ "An empty skull?! A lich?! No... no... it is horrible! My lord, how did you come to this?"
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"I lingered for weeks in agony. Only my hatred and the runelore of old sustained me, until I became as I am. I will have revenge; I will destroy the orcs, and the humans, and the elves, and all but the true people!"}
        [/message]
        [message]
            speaker=Karrag
            message={KARRAG_BLUE _"And you have sealed your doom. Hundreds of dirtgrubbers have already died to weave a web of blood around the Hammer and the soul of the dwarves. You and your new friends will be the last sacrifices I require to bind the entire dwarvish race to my purpose. Take the Knalgans, and Dulcatulos too! TAKE THEM!"}
        [/message]
        # Put his mask back on so we don't have to deal with yet another unit type
        # for his maskless variation
        {MODIFY_UNIT (id=Karrag) variation none}
        # disable Karrag's attacks. He's an illusion, not a real being
        [object]
            [filter]
                id=Karrag
            [/filter]
            [effect]
                apply_to=attack
                attack_weight=0
                defense_weight=0
            [/effect]
        [/object]
        {REDRAW}
        [modify_unit]
            [filter]
                id=Dulcatulos
            [/filter]
            canrecruit=no
            {TRAIT_LOYAL_HERO_NOSLOT}
            side=1
        [/modify_unit]
        
        #############################
        # EVIL DWARVES
        #############################
        # can't scale too much here. We need the guards to be beatable even if the player comes into this scenario with no recalls
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "Dwarvish Masked Fighter"   "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"   }) 20 6 ({ANIMATE}{FACING sw})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "Dwarvish Masked Fighter"   "Dwarvish Masked Fighter"      "Dwarvish Masked Steelclad"   }) 20 8 ({ANIMATE}{FACING sw})}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none"                      "Dwarvish Masked Ulfserker"    "Dwarvish Masked Ulfserker"}) 18 5 ({ANIMATE} {FACING sw})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "Dwarvish Masked Ulfserker" "none"                         "Dwarvish Masked Berserker"}) 16 7 ({ANIMATE} {FACING sw})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none"                      "Dwarvish Masked Ulfserker"    "Dwarvish Masked Ulfserker"}) 18 9 ({ANIMATE} {FACING sw})}
        
        # these guys aren't meant to be fought. They're a timer, more or less
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Fighter"      "Dwarvish Masked Steelclad"   }) 7  1 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Thunderguard" "Dwarvish Masked Thunderguard"}) 7  1 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Thunderguard" "Dwarvish Masked Thunderguard"}) 7  1 ({ANIMATE})}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Thunderer"    "Dwarvish Masked Thunderguard"}) 27  1 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Thunderguard" "Dwarvish Masked Thunderguard"}) 27  1 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Thunderer"    "Dwarvish Masked Thunderguard"}) 27  1 ({ANIMATE})}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"   }) 28 14 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Fighter"      "Dwarvish Masked Steelclad"   }) 28 14 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Fighter"      "Dwarvish Masked Steelclad"   }) 28 14 ({ANIMATE})}
        
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"   })  3 21 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Thunderer"    "Dwarvish Masked Thunderguard"})  3 21 ({ANIMATE})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY "none" "Dwarvish Masked Steelclad"    "Dwarvish Masked Steelclad"   })  3 21 ({ANIMATE})}
        
        #############################
        # ALLIED DWARVES
        #############################
        {RECALL_VETERAN "Dwarvish Thunderguard" 13 11}
        {RECALL_VETERAN "Dwarvish Steelclad"    14 11}
        [message]
            speaker=narrator
            message= _ "Neither side can recruit or recall. You must win with the troops you have."
            image=wesnoth-icon.png
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [change_theme]
        [/change_theme]
        [objectives]
            [objective]
                description= _ "Defeat Karrag"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Aiglondur or Angarthing"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Dulcatulos"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]
    
    #############################
    # DULCATULOS ATTACKS
    #############################
    [event]
        name=attack
        [filter]
            id=Dulcatulos
        [/filter]
        [message]
            speaker=Dulcatulos
            message= _ "A lich is no lord of mine!"
        [/message]
    [/event]

    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # DISCOVER KARRAG
    #############################
    # if we attack twice, we realize he's an illusion
    [event]
        name=attack
        [filter_second]
            id=Karrag
        [/filter_second]
        [event]
            name=attack
            [filter_second]
                id=Karrag
            [/filter_second]
            [message]
                speaker=Aiglondur
                message= _ "Wait... something is not right. Karrag is not fighting back. He is nothing but an illusion! Look — there is a doorway behind the throne!"
            [/message]
            {SOUND skill-illusion-quiet.wav}
            {KILL id=Karrag}
            [endlevel]
                result=victory
                bonus=yes
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
    [/event]
    
    #############################
    # DEFEAT KARRAG
    #############################
    [event]
        name=last breath
        [filter]
            id=Karrag
        [/filter]
        {SOUND skill-illusion-quiet.wav}
        {KILL id=Karrag}
        [message]
            speaker=Aiglondur
            message= _ "What is this? Karrag did not fight back. He is nothing but an illusion! Look — there is a doorway behind the throne!"
        [/message]
    [/event]
    
    #############################
    # VICTORY
    #############################
    [event]
        name=victory
        [message]
            speaker=Dulcatulos
            message= _ "Then Karrag has fled to the underlevels. None but his masked ones go there any more."
        [/message]
        [message]
            speaker=Angarthing
            message= _ "We must follow. Quickly! It may be his talk of perverting the Hammer was merely mad raving, but we cannot allow the risk that his foul spell might succeed."
        [/message]
    [/event]

    {HERODEATH_AIGLONDUR}
    {HERODEATH_ANGARTHING}
    {HERODEATH_DULCATULOS}
[/scenario]
