#textdomain wesnoth-thot





#define ENABLE_GRENADIER
    # Place in a campaign or scenario definition to allow Dwarvish Thunderer to advance to Dwarvish Grenadier.
    {ENABLE_ADVANCEMENT "Dwarvish Thunderer" "Dwarvish Grenadier" ()}
#enddef





#define WEAPON_SPECIAL_SMOKE_ACCURACY_DEBUFF X Y
    [object]
        id=weaponSpecialSmoke_debuff_{X}_{Y}
        duration=scenario
        [effect]
            apply_to=attack
            [set_specials]
                mode=append
                
                # worse accuracy when smoked
                [chance_to_hit]
                    [filter_self]
                        x,y={X},{Y}
                        [filter_weapon]
                            [not]
                                special_id=magical
                            [/not]
                        [/filter_weapon]
                    [/filter_self]
                    multiply=0.5
                    # I can't figure out how do disable marksman when smoked (without actually modifying the marksman ability), so this means that smoked marksman units end up with 60% / 2 = 30% cth - probably fine
                [/chance_to_hit]
                
            [/set_specials]
        [/effect]
    [/object]
#enddef

#define WEAPON_SPECIAL_SMOKE_APPLY_ZOC_DEBUFF
    [modify_unit]
        [filter]
            x,y=$weaponSpecialSmoke_x,$weaponSpecialSmoke_y
        [/filter]
        [object]
            id=weaponSpecialSmoke_debuff_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
            duration=scenario
            [effect]
                apply_to=zoc
                value=no
            [/effect]
        [/object]
    [/modify_unit]
#enddef

#define WEAPON_SPECIAL_SMOKE
    [dummy]
        id=smoke
        name= _ "smoke"
        female_name= _ "female^smoke"
        description= _ "Hit or miss, this attack creates a cloud of cloying, caustic smoke on the targeted hex. Any unit inside suffers halved accuracy and can no longer enforce a zone of control. The cloud lasts until the start of this unit’s next turn.

<i>Magical</i> attacks are unaffected by smoke."
        special_note=_"This unit’s attacks create clouds of caustic smoke, reducing accuracy and nullifying zone of control for any unit caught inside."
        
        [event]
            name=unit hits,unit misses
            first_time_only=no
            [filter_attack]
                special_id=smoke
            [/filter_attack]
            {VARIABLE weaponSpecialSmoke_side $unit.side}
            {VARIABLE weaponSpecialSmoke_x $second_unit.x}
            {VARIABLE weaponSpecialSmoke_y $second_unit.y}
            
            #--------------------
            # CLEAR PREEXISTING SMOKE AND EVENTS
            #--------------------
            [fire_event]
                name=weaponSpecialSmoke_clear_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
            [/fire_event]
            
            #--------------------
            # CREATE VISUAL
            #--------------------
            [item]
                name=weaponSpecialSmoke_cloud
                x,y=$weaponSpecialSmoke_x,$weaponSpecialSmoke_y
                halo=halo/smoke/[0001~0015].png~SCALE(130,100)~GS()
#                 image=halo/smoke/highlight-hex.png~GS()~O(0.3)
            [/item]
            
            #--------------------
            # APPLY ACCURACY DEBUFF
            #--------------------
            # debuff ALL units on the map - but the debuff is only active on this specific hex
            # we do this so that the combat preview will accurately reflect CTH if you move into/out of smoke during the preview
            # and so that the AI understands how smoke works (I think)
            [modify_unit]
                [filter]
                [/filter]
                {WEAPON_SPECIAL_SMOKE_ACCURACY_DEBUFF $weaponSpecialSmoke_x $weaponSpecialSmoke_y}
            [/modify_unit]
            [event]
                name=unit placed
                id=weaponSpecialSmoke_unitplaced_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                first_time_only=no
                delayed_variable_substitution=no
                [modify_unit]
                    [filter]
                        id=$|unit.id
                    [/filter]
                    {WEAPON_SPECIAL_SMOKE_ACCURACY_DEBUFF $weaponSpecialSmoke_x $weaponSpecialSmoke_y}
                [/modify_unit]
            [/event]
            
            #--------------------
            # APPLY INITIAL ZOC DEBUFF
            #--------------------
            {WEAPON_SPECIAL_SMOKE_APPLY_ZOC_DEBUFF}
            
            #--------------------
            # APPLY PERSISTENT ZOC DEBUFF
            #--------------------
            [event]
                name=moveto
                id=weaponSpecialSmoke_moveto_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                first_time_only=no
                delayed_variable_substitution=no
                [filter]
                    x,y=$weaponSpecialSmoke_x,$weaponSpecialSmoke_y
                [/filter]
                {WEAPON_SPECIAL_SMOKE_APPLY_ZOC_DEBUFF}
                
                [allow_undo]
                [/allow_undo]
                [on_undo]
                    delayed_variable_substitution=no
                    [remove_object]
                        object_id=weaponSpecialSmoke_debuff_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                    [/remove_object]
                [/on_undo]
                {CLEAR_VARIABLE weaponSpecialSmoke_id}
            [/event]
            
            #--------------------
            # REMOVE PERSISTENT ZOC DEBUFF
            #--------------------
            # if we're leaving this hex and have the debuff, remove it
            # only trigger this event if we actually have the debuff - that lets us safely add it back in if they undo
            [event]
                name=exit hex
                id=weaponSpecialSmoke_exithex_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                first_time_only=no
                delayed_variable_substitution=no
                [filter]
                    x,y=$weaponSpecialSmoke_x,$weaponSpecialSmoke_y
                    [filter_wml]
                        [modifications]
                            [object]
                                id=weaponSpecialSmoke_debuff_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                            [/object]
                        [/modifications]
                    [/filter_wml]
                [/filter]
                [remove_object]
                    object_id=weaponSpecialSmoke_debuff_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_object]
                
                [allow_undo]
                [/allow_undo]
                [on_undo]
                    {WEAPON_SPECIAL_SMOKE_APPLY_ZOC_DEBUFF}
                [/on_undo]
            [/event]
            
            #--------------------
            # CLEAR SMOKE
            #--------------------
            # clear smoke at the start of this side's next turn
            [event]
                name=side $weaponSpecialSmoke_side turn end
                id=weaponSpecialSmoke_turnend1_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                delayed_variable_substitution=no
                [event]
                    name=side $weaponSpecialSmoke_side turn
                    id=weaponSpecialSmoke_turnend2_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                    delayed_variable_substitution=no
                    [fire_event]
                        name=weaponSpecialSmoke_clear_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                    [/fire_event]
                [/event]
            [/event]
            [event]
                name=weaponSpecialSmoke_clear_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                delayed_variable_substitution=no
                [remove_event]
                    id=weaponSpecialSmoke_turnend1_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_event]
                [remove_event]
                    id=weaponSpecialSmoke_turnend2_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_event]
                [remove_event]
                    id=weaponSpecialSmoke_unitplaced_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_event]
                [remove_event]
                    id=weaponSpecialSmoke_moveto_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_event]
                [remove_event]
                    id=weaponSpecialSmoke_exithex_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_event]
                [remove_item]
                    x,y=$weaponSpecialSmoke_x,$weaponSpecialSmoke_y
                    image=weaponSpecialSmoke_cloud
                [/remove_item]
                [remove_object]
                    object_id=weaponSpecialSmoke_debuff_$weaponSpecialSmoke_x|_$weaponSpecialSmoke_y
                [/remove_object]
            [/event]
            
#             #--------------------
#             # EXPLAIN SMOKE
#             #--------------------
#             [fire_event]
#                 name=weaponSpecialSmoke_explain
#                 [primary_unit]
#                     id=$second_unit.id
#                 [/primary_unit]
#             [/fire_event]
            
            {CLEAR_VARIABLE weaponSpecialSmoke_side,weaponSpecialSmoke_x,weaponSpecialSmoke_y}
        [/event]
        
#         #--------------------
#         # EXPLAIN SMOKE
#         #--------------------
#         [event]
#             name=weaponSpecialSmoke_explain
#             [filter_condition]{VARIABLE_CONDITIONAL weapon_special_smoke_explained not_equals yes}[/filter_condition]
#             [filter]
#                 [not]
#                     race=monster,gryphon,ogre,undead
#                 [/not]
#             [/filter]
#             [message]
#                 speaker=unit
#                 message= _ "Gah, my eyes are burning! What is this stuff?!"
#             [/message]
#             {VARIABLE weapon_special_smoke_explained yes}
#         [/event]
    [/dummy]
#enddef





#define PATH_TEMP
units/dwarves/#enddef

[unit_type]
    id=Dwarvish Grenadier
    name= _ "Dwarvish Grenadier"
    race=dwarf
    image="{PATH_TEMP}grenadier.png"
    profile="portraits/grenadier.png"
    hitpoints=45
    movement_type=dwarvishfoot
    movement=4
    experience=100
    level=2
    alignment=neutral
    advances_to=null
    {AMLA_DEFAULT}
    cost=24
    usage=archer
    description= _ "Upon the person of a fallen dwarf, the arch-mage Ravan (before his fall to evil) once espied a pouch, carefully sealed and filled — unbeknownst to him — of a fine black dust. 

Arthritic fingers unable to loose the knot that held tight its mouth, Ravan leaned forward, muttering under his breath an arcane word of opening. Sparks lept from his fingers—"
    die_sound={SOUND_LIST:DWARF_DIE}
    {DEFENSE_ANIM "{PATH_TEMP}burner-defend2.png" "{PATH_TEMP}burner-defend1.png" {SOUND_LIST:HUMAN_HIT} }
    
    [attack]
        name=dagger
        description=_"dagger"
        icon=attacks/dagger-human.png
        type=blade
        range=melee
        damage=7
        number=2
    [/attack]
    [attack]
        name=flashpowder
        description=_"flashpowder"
        icon=attacks/flashpowder.png
        type=fire
        range=ranged
        damage=10
        number=1
        [specials]
            {WEAPON_SPECIAL_SMOKE}
        [/specials]
        attack_weight=2.5
    [/attack]
    [attack]
        name=firecrackers
        description=_"firecrackers"
        icon=attacks/firecrackers.png
        type=fire
        range=ranged
        damage=7
        number=3
    [/attack]
    
    [attack_anim]
        [filter_attack]
            name=dagger
        [/filter_attack]
        start_time=-200
        [frame]
            image="{PATH_TEMP}grenadier.png:300"
        [/frame]
        {SOUND:HIT_AND_MISS dagger-swish.wav dagger-swish.wav -150}
    [/attack_anim]
    
    # https://freesound.org/people/TB0Y298/sounds/718948/
    # https://freesound.org/people/elricadavis/sounds/764601/
    
    [attack_anim]
        [filter_attack]
            name=flashpowder
        [/filter_attack]
        start_time=-500
        missile_start_time=-200
        [if]
            hits=yes
            [missile_frame]
                duration=200
                image="projectiles/naphtha-gob-n.png"
                # image_diagonal="projectiles/naphtha-gob-ne.png" # this is just a symmetric ball for now, but will probably change
                offset=0~0.8
                y=-5~-45:100,-45~-5:100
            [/missile_frame]
            {FIRE_BURST_SMALL}
            [+missile_frame]
                y=-5~20
            [/missile_frame]
            [frame]
                image="{PATH_TEMP}grenadier.png:[100*8]"
                sound=bow-puny-fire.ogg
            [/frame]
        [/if]
        [else]
            hits=no
            [missile_frame]
                duration=200
                image="projectiles/naphtha-gob-n.png"
                # image_diagonal="projectiles/naphtha-gob-ne.png"
                y=-5~-45:100,-45~-5:100
            [/missile_frame]
            [frame]
                image="{PATH_TEMP}grenadier.png:[100*8]"
                sound=bow-puny-fire-miss.ogg
            [/frame]
        [/else]
    [/attack_anim]
[/unit_type]

#undef PATH_TEMP
